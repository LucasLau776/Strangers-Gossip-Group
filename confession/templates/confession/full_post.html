{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ post.title }} - MMU Strangers Gossip</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  {% include 'confession/navbar.html' %}

  <!-- üü¶ Post Container -->
  <div class="container mt-5">
    <div class="card p-4 mb-4">
      <h2 class="card-title" style="text-align: left;">{{ post.title }}</h2>
      <p style="text-align: left;">{{ post.content }}</p>
      <p style="text-align: left; font-size: 0.9rem;">Posted {{ post.created_at|timesince }} ago</p>

      <div style="text-align: left;" class="mb-3">
        <button class="btn btn-primary like-btn" data-post-id="{{ post.id }}">
          üëç Like (<span id="like-count">{{ post.likes.count }}</span>)
        </button>
       
        {% if is_saved %}
          <button class="btn btn-primary save-btn" data-post-id="{{ post.id }}">
            üìå Unsave
          </button>
        {% else %}
          <button class="btn btn-primary save-btn" data-post-id="{{ post.id }}">
            üìå Save
          </button>
        {% endif %}

        <a href="{% url 'report_post' 'post' post.id %}" class="btn btn-danger">
          üö© Report
        </a>
      </div>
    </div>
  </div>

  <!-- üü® Comment Section -->
  <div class="container">
    {% if comments %}
    <div class="card p-4 mb-4">
      <h4 style="text-align: left;">Comments</h4>

      {% for comment in comments %}
        <div class="border p-3 mb-3">
          <p style="text-align: left;">
            <strong>
              {% if comment.session_key == 'anonymous' %}
                Anonymous
              {% else %}
                User {{ comment.session_key }}
              {% endif %}
            </strong>: {{ comment.content }}
          </p>
          <div style="text-align: left;">
            <button class="btn btn-sm btn-primary comment-like-btn" data-comment-id="{{ comment.id }}">
              üëç Like (<span id="comment-like-{{ comment.id }}">{{ comment.likes.count }}</span>)
            </button>
            <button class="btn btn-sm btn-light reply-btn" data-comment-id="{{ comment.id }}">Reply</button>
            <a href="{% url 'report_post' 'comment' comment.id %}" class="btn btn-sm btn-light">Report</a>
          </div>

          <!-- üüß Hidden Reply Form -->
          <div class="reply-form mt-2" id="reply-form-{{ comment.id }}" style="display: none;">
            <form method="POST" class="reply-submit-form" data-comment-id="{{ comment.id }}">
              {% csrf_token %}
              <textarea name="reply_content" class="form-control mb-2" rows="2" placeholder="Write your reply..." required></textarea>
              <button type="submit" class="btn btn-sm btn-success">Submit Reply</button>
            </form>
          </div>

          <!-- üü© ÊòæÁ§∫ replies -->
          {% for reply in comment.replies.all %}
            <div class="border p-2 mt-2 ms-4 bg-light rounded">
              <p style="text-align: left; font-size: 0.95rem;">
                <strong>
                  {% if reply.session_key == 'anonymous' %}
                    Anonymous
                  {% else %}
                    User {{ reply.session_key }}
                  {% endif %}
                </strong>: {{ reply.content }}
              </p>
            </div>
          {% endfor %}

        </div>
      {% endfor %}
    </div>
    {% endif %}
    
    <!-- ÁïôË®ÄÂå∫ -->
    <div class="card p-4 mb-5">
      <h5 style="text-align: left;">Leave a Comment</h5>
      <form id="comment-form" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <textarea name="content" rows="3" class="form-control mb-2" placeholder="Write your comment here..." required></textarea>
        <input type="file" name="image" class="form-control-file mb-2">
        <input type="hidden" name="post_id" value="{{ post.id }}">
        <div style="text-align: left;">
          <button type="submit" class="btn btn-primary">Post Comment</button>
        </div>
      </form>
    </div>
  </div>

  {% include 'confession/floating_buttons.html' %}
  {% include 'confession/footer.html' %}

  <script src="{% static 'js/main.js' %}"></script>

  <!-- üü© Reply ScriptÔºàÂè™Â§ÑÁêÜ replyÔºâ -->
  <script>
    $(document).on("click", ".reply-btn", function () {
      const commentId = $(this).data("comment-id");
      $("#reply-form-" + commentId).toggle();
    });

    $(document).on("submit", ".reply-submit-form", function (e) {
      e.preventDefault();
      const commentId = $(this).data("comment-id");
      const content = $(this).find("textarea[name='reply_content']").val();
      const csrfToken = $(this).find("[name='csrfmiddlewaretoken']").val();

      if (!content.trim()) {
        alert("Reply cannot be empty.");
        return;
      }

      $.ajax({
        url: "/confession/add_reply/",
        method: "POST",
        data: {
          comment_id: commentId,
          content: content,
          csrfmiddlewaretoken: csrfToken
        },
        success: function () {
          location.reload();
        },
        error: function () {
          alert("Failed to post reply.");
        }
      });
    });
  </script>
</body>
</html>
