{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Moderation Panel - MMU Strangers Gossip</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* Base styles */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 0;
      transition: background-color 0.3s, color 0.3s;
    }
    
    /* Dark mode styles */
    body.dark-mode {
      background-color: #121212;
      color: #f0f0f0;
    }
    
    body.dark-mode .panel,
    body.dark-mode .stat-card {
      background-color: #1e1e1e;
      border-color: #444;
    }
    
    body.dark-mode .stat-card {
      background-color: #2c2c2c;
    }
    
    body.dark-mode .moderation-table th,
    body.dark-mode .moderation-table td {
      border-bottom: 1px solid #444;
    }
    
    /* Main content styles */
    .content {
      padding: 100px 20px 40px;
      max-width: 1100px;
      margin: auto;
    }
    
    .panel {
      background-color: #ffffff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
    }
    
    .panel h2 {
      margin-top: 0;
      color: #377FC6;
    }
    
    body.dark-mode .panel h2 {
      color: #7c88ff;
    }
    
    /* Stats cards */
    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .stat-card {
      flex: 1;
      min-width: 150px;
      padding: 15px;
      background: #f0f0f0;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
    }
    
    .stat-card strong {
      font-size: 1.5rem;
      color: #377FC6;
      display: block;
      margin-top: 5px;
    }
    
    body.dark-mode .stat-card strong {
      color: #7c88ff;
    }
    
    /* Filters */
    .filters {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filters select, 
    .filters input {
      padding: 8px 12px;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid #ccc;
      background-color: white;
      min-width: 200px;
    }
    
    body.dark-mode .filters select,
    body.dark-mode .filters input {
      background-color: #2c2c2c;
      border-color: #444;
      color: #f0f0f0;
    }
    
    /* Tabs */
    .tab-container {
      margin-bottom: 20px;
    }
    
    .tab-buttons {
      display: flex;
      border-bottom: 2px solid #377FC6;
      background-color: #f5f5f5;
      border-radius: 8px 8px 0 0;
      padding: 5px 5px 0 5px;
    }
    
    .tab-btn {
      padding: 10px 20px;
      background: #e0e0e0;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      position: relative;
      margin-right: 5px;
      border-radius: 5px 5px 0 0;
      color: #333;
      transition: all 0.2s ease;
    }
    
    .tab-btn.active {
      font-weight: bold;
      color: white;
      background-color: #377FC6;
    }
    
    .tab-btn:hover:not(.active) {
      background-color: #d0d0d0;
    }
    
    body.dark-mode .tab-buttons {
      background-color: #2a2a2a;
      border-bottom-color: #7c88ff;
    }
    
    body.dark-mode .tab-btn {
      background: #3a3a3a;
      color: #f0f0f0;
    }
    
    body.dark-mode .tab-btn.active {
      background-color: #2a64a4;
    }
    
    body.dark-mode .tab-btn:hover:not(.active) {
      background-color: #4a4a4a;
    }
    
    /* Tables */
    .moderation-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: white;
    }
    
    .moderation-table th {
      background-color: #377FC6;
      color: white;
      padding: 12px;
      text-align: left;
    }
    
    body.dark-mode .moderation-table th {
      background-color: #2a64a4;
    }
    
    .moderation-table td {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .moderation-table tr:hover {
      background-color: #f5f5f5;
    }
    
    body.dark-mode .moderation-table {
      background-color: #1e1e1e;
    }
    
    body.dark-mode .moderation-table td {
      border-bottom-color: #444;
    }
    
    body.dark-mode .moderation-table tr:hover {
      background-color: #2a2a2a;
    }
    
    /* Action buttons */
    .action-btn {
      padding: 6px 12px;
      margin: 2px;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
      transition: opacity 0.2s;
    }
    
    .action-btn:hover {
      opacity: 0.9;
    }
    
    .delete-btn { background-color: #e74c3c; }
    .dismiss-btn { background-color: #3498db; }
    .warn-btn { background-color: #f39c12; }
    .ban-btn { background-color: #8e44ad; }
    .unban-btn { background-color: #2ecc71; }
    
    /* Tab content */
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Priority indicators */
    .priority-high {
      background-color: #ffebee;
    }
    
    body.dark-mode .priority-high {
      background-color: #3a1a1a;
    }
    
    .priority-medium {
      background-color: #fff8e1;
    }
    
    body.dark-mode .priority-medium {
      background-color: #3a2e1a;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .stats {
        flex-direction: column;
      }
      
      .stat-card {
        width: 100%;
      }
      
      .moderation-table {
        font-size: 0.9rem;
      }
      
      .moderation-table th,
      .moderation-table td {
        padding: 8px;
      }
      
      .tab-buttons {
        flex-wrap: wrap;
      }
      
      .tab-btn {
        flex: 1;
        min-width: 100px;
        padding: 8px 10px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body class="{% if request.COOKIES.theme == 'dark' %}dark-mode{% endif %}">

  {% include 'confession/navbar.html' %}

  <div class="content">
    <div class="panel">
      <h2>Moderation Panel</h2>

      <div class="stats">
        <div class="stat-card">
          Total Reports: <strong>{{ total_reports }}</strong>
        </div>
        <div class="stat-card">
          Pending: <strong>{{ pending_reports }}</strong>
        </div>
        <div class="stat-card">
          Resolved: <strong>{{ resolved_reports }}</strong>
        </div>
        <div class="stat-card">
          Banned Users: <strong>{{ banned_users }}</strong>
        </div>
      </div>

      <div class="tab-container">
        <div class="tab-buttons">
          <button class="tab-btn active" data-tab="posts">Reported Posts</button>
          <button class="tab-btn" data-tab="comments">Reported Comments</button>
          <button class="tab-btn" data-tab="users">User Management</button>
        </div>
        
        <div class="filters">
          <select id="statusFilter">
            <option value="all">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="resolved">Resolved</option>
          </select>
          <select id="priorityFilter">
            <option value="all">All Priorities</option>
            <option value="high">High Priority</option>
            <option value="medium">Medium Priority</option>
            <option value="low">Low Priority</option>
          </select>
          <input type="text" id="searchFilter" placeholder="Search content...">
        </div>
        
        <!-- Posts Tab -->
        <div id="posts-tab" class="tab-content active">
          <table class="moderation-table">
            <thead>
              <tr>
                <th>Post ID</th>
                <th>Content</th>
                <th>Author</th>
                <th>Reports</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for post in reported_posts %}
              <tr class="priority-{{ post.priority }}">
                <td>#{{ post.id }}</td>
                <td>{{ post.content|truncatechars:50 }}</td>
                <td>{{ post.user.username|default:"Anonymous" }}</td>
                <td>{{ post.report_count }}</td>
                <td>{{ post.status_display }}</td>
                <td>
                  <button class="action-btn delete-btn" data-id="{{ post.id }}" data-type="post">Delete</button>
                  {% if post.status == 'pending' %}
                    <button class="action-btn dismiss-btn dismiss-button" data-id="{{ post.id }}" data-type="post">Dismiss</button>
                  {% else %}
                    <button class="action-btn dismiss-btn dismiss-button" data-id="{{ post.id }}" data-type="post" data-remove="true">Dismiss</button>
                  {% endif %}
                  {% if post.user %}
                  <button class="action-btn warn-btn" data-id="{{ post.user.id }}">Warn</button>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" style="text-align: center;">No reported posts found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <!-- Comments Tab -->
        <div id="comments-tab" class="tab-content">
          <table class="moderation-table">
            <thead>
              <tr>
                <th>Comment ID</th>
                <th>Content</th>
                <th>Author</th>
                <th>Post ID</th>
                <th>Reports</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for comment in reported_comments %}
              <tr class="priority-{{ comment.priority }}">
                <td>#{{ comment.id }}</td>
                <td>{{ comment.content|truncatechars:50 }}</td>
                <td>{{ comment.user.username|default:"Anonymous" }}</td>
                <td>#{{ comment.post.id }}</td>
                <td>{{ comment.report_count }}</td>
                <td>{{ comment.status_display }}</td>
                <td>
                  <button class="action-btn delete-btn" data-id="{{ comment.id }}" data-type="comment">Delete</button>
                  {% if comment.status == 'pending' %}
                    <button class="action-btn dismiss-btn dismiss-button" data-id="{{ comment.id }}" data-type="comment">Dismiss</button>
                  {% else %}
                    <button class="action-btn dismiss-btn dismiss-button" data-id="{{ comment.id }}" data-type="comment" data-remove="true">Dismiss</button>
                  {% endif %}
                  {% if comment.user %}
                    <button class="action-btn warn-btn" data-id="{{ comment.user.id }}">Warn</button>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" style="text-align: center;">No reported comments found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <!-- Users Tab -->
        <div id="users-tab" class="tab-content">
          <table class="moderation-table">
            <thead>
              <tr>
                <th>User ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Warnings</th>
                <th>Status</th>
                <th>Ban Expiry</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for user in problem_users %}
              <tr>
                <td>#{{ user.id }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.userprofile.warning_count }}</td>
                <td>
                  {% if user.userprofile.is_banned %}
                    <span style="color: #e74c3c;">Banned</span>
                  {% else %}
                    <span style="color: #2ecc71;">Active</span>
                  {% endif %}
                </td>
                <td>
                  {% if user.userprofile.is_banned %}
                    {{ user.userprofile.ban_expiry|date:"Y-m-d H:i"|default:"Permanent" }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if not user.userprofile.is_banned %}
                    <button class="action-btn ban-btn" data-id="{{ user.id }}">Ban</button>
                  {% else %}
                    <button class="action-btn unban-btn" data-id="{{ user.id }}">Unban</button>
                  {% endif %}
                  <button class="action-btn warn-btn" data-id="{{ user.id }}">Warn</button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" style="text-align: center;">No problematic users found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  {% include 'confession/floating_buttons.html' %}
  {% include 'confession/footer.html' %}

  <script>
    // Tab functionality
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // Remove active class from all buttons and tabs
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        
        // Add active class to clicked button and corresponding tab
        btn.classList.add('active');
        document.getElementById(`${btn.dataset.tab}-tab`).classList.add('active');
      });
    });
    
    // Filter functionality
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('priorityFilter').addEventListener('change', applyFilters);
    document.getElementById('searchFilter').addEventListener('input', applyFilters);
    
    function applyFilters() {
      const statusFilter = document.getElementById('statusFilter').value;
      const priorityFilter = document.getElementById('priorityFilter').value;
      const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
      
      const activeTab = document.querySelector('.tab-content.active').id;
      const tableBody = document.querySelector(`#${activeTab} tbody`);
      
      Array.from(tableBody.children).forEach(row => {
          if (row.tagName !== 'TR') return;
          
          const statusCell = row.querySelector('td:nth-last-child(2)');
          const status = statusCell ? statusCell.textContent.trim().toLowerCase() : '';
          
          // Priority is determined by report count
          const reportCount = parseInt(row.querySelector('td:nth-last-child(3)').textContent) || 0;
          let priority = 'low';
          if (reportCount > 5) priority = 'high';
          else if (reportCount > 2) priority = 'medium';
          
          const content = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
          
          const statusMatch = statusFilter === 'all' || 
                            (statusFilter === 'pending' && status.includes('pending')) ||
                            (statusFilter === 'resolved' && status.includes('resolved'));
          
          const priorityMatch = priorityFilter === 'all' || priority === priorityFilter;
          const searchMatch = content.includes(searchFilter);
          
          row.style.display = statusMatch && priorityMatch && searchMatch ? '' : 'none';
        });
    }
    
    // Action button handlers
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', handleDelete);
    });
    
    document.querySelectorAll('.dismiss-btn').forEach(btn => {
      btn.addEventListener('click', handleDismiss);
    });
    
    document.querySelectorAll('.warn-btn').forEach(btn => {
      btn.addEventListener('click', handleWarn);
    });
    
    document.querySelectorAll('.ban-btn').forEach(btn => {
      btn.addEventListener('click', handleBan);
    });
    
    document.querySelectorAll('.unban-btn').forEach(btn => {
      btn.addEventListener('click', handleUnban);
    });
    
    async function handleDelete(e) {
      const id = e.target.dataset.id;
      const type = e.target.dataset.type;
      
      if (confirm(`Are you sure you want to delete this ${type}?`)) {
        try {
          const response = await fetch(`/confession/moderation/delete/${type}/${id}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}',
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
          });
          
          const result = await response.json();
          if (response.ok) {
            alert(`${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully`);
            window.location.reload();
          } else {
            alert('Error deleting content');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('An error occurred');
        }
      }
    }
    
    async function handleDismiss(e) {
      const id = e.target.dataset.id;
      const type = e.target.dataset.type;
      const remove = e.target.dataset.remove === 'true';
      const row = e.target.closest('tr');
    
      if (confirm(remove ? 'Remove this item from view?' : 'Dismiss reports for this content?')) {
        try {
          const response = await fetch(`/confession/moderation/dismiss/${type}/${id}/`, {
              method: 'POST',
              headers: {
                  'X-CSRFToken': '{{ csrf_token }}',
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({remove: remove})
          });
        
          const result = await response.json();
          if (result.success) {
              if (remove) {
                  row.remove();
              } else {
                  const statusCell = row.querySelector('td:nth-last-child(2)');
                  if (statusCell) {
                      statusCell.textContent = 'Resolved';
                  }
                  e.target.dataset.remove = 'true';
                  e.target.textContent = 'Dismiss (Remove)';
              }
              alert(remove ? 'Item removed successfully' : 'Reports dismissed successfully');
          } else {
              alert(result.error || 'Error dismissing reports');
          }
      } catch (error) {
          console.error('Error:', error);
          alert('An error occurred');
      }
    }
  }

    async function handleWarn(e) {
      const userId = e.target.dataset.id;
      const reason = prompt('Enter warning reason:');
    
      if (reason) {
        try {
            const response = await fetch(`/confession/moderation/warn/${userId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ reason })
            });
            
            const result = await response.json();
            if (result.success) {
                alert(`User warned successfully. Total warnings: ${result.warning_count}`);
                window.location.reload();  // Refresh to show updated warning count
            } else {
                alert(result.error || 'Error warning user');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred');
        }
      }
    }
    
    async function handleBan(e) {
      const userId = e.target.dataset.id;
      const reason = prompt('Enter ban reason:');
      const duration = prompt('Enter ban duration in days (default 7):', '7');
    
      if (reason) {
        try {
            const response = await fetch(`/confession/moderation/ban/${userId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ reason, duration })
            });
            
            const result = await response.json();
            if (result.success) {
                alert(`User banned successfully until ${result.ban_expiry}`);
                window.location.reload();
            } else {
                alert(result.error || 'Error banning user');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred');
        }
      }
    }
    
    async function handleUnban(e) {
      const userId = e.target.dataset.id;
      
      if (confirm('Are you sure you want to unban this user?')) {
        try {
          const response = await fetch(`/confession/moderation/unban/${userId}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}',
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
          });
          
          const result = await response.json();
          if (result.success) {
            alert('User unbanned successfully');
            window.location.reload();
          } else {
            alert(result.error || 'Error unbanning user');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('An error occurred');
        }
      }
    }
  </script>
</body>
</html>