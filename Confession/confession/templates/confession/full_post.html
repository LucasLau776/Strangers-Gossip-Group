{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ post.title }} - MMU Strangers Gossip</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    /* ===== Day Mode (Default) ===== */
    body {
      background-color: #fff;
      color: #000;
      font-family: Arial, sans-serif;
    }
    .container {
      background-color: #f9f9f9;
      max-width: 800px;
      margin: 0 auto;
      padding: 0 15px;
    }
    .top-nav {
      display: flex;
      justify-content: space-between;
      background-color: #377FC6;
      padding: 10px 20px;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 10;
      box-sizing: border-box;
      flex-wrap: wrap;
    }
    .logo a {
      color: white;
      text-decoration: none;
      font-size: 1.5rem;
      font-weight: bold;
      padding: 5px 10px;
    }
    .search-container {
      flex-grow: 1;
      margin: 0 10px;
    }
    .search-container input {
      width: 100%;
      padding: 8px;
      font-size: 1rem;
      border-radius: 5px;
      border: none;
      background-color: white;
      color: #000;
    }
    .nav-links {
      display: flex;
      align-items: center;
    }
    .nav-links a {
      color: white;
      text-decoration: none;
      margin: 0 10px;
      font-size: 1rem;
      padding: 5px 10px;
    }
    .nav-links a:hover {
      text-decoration: underline;
    }
    .card {
      background-color: #fff;
      color: #000;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-top: 20px;
      padding: 20px;
    }
    .border {
      border-color: #ccc !important;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ddd;
      flex-shrink: 0;
    }
    .user-avatar.small {
      width: 30px;
      height: 30px;
    }
    .d-flex {
      display: flex;
    }
    .align-items-start {
      align-items: flex-start;
    }
    .bg-light {
      background-color: #f8f9fa !important;
      color: #000;
    }
    .btn-primary {
      background-color: #007bff;
      border-color: #007bff;
      color: #fff;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid transparent;
    }
    .btn-primary:hover {
      background-color: #0056b3;
      border-color: #004085;
    }
    .btn-danger {
      background-color: #dc3545;
      border-color: #dc3545;
      color: #fff;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid transparent;
      text-decoration: none;
      display: inline-block;
    }
    .btn-danger:hover {
      background-color: #c82333;
      border-color: #bd2130;
    }
    textarea,
    input[type="file"] {
      background-color: #fff;
      color: #000;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
      resize: vertical;
      padding: 8px;
      font-size: 1rem;
      box-sizing: border-box;
    }
  .media-container {
    margin: 10px 0;
    overflow: hidden;
    position: relative;
  }
  .user-uploaded-media {
    display: block;
    max-width: 300px;
    max-height: 200px;
    width: auto;
    height: auto;
    border: 1px solid #ddd;
    background: #f5f5f5;
    object-fit: contain;
  }
  .dark-mode .user-uploaded-media {
    background: #2a2a2a;
    border-color: #444;
  }
  .gif-image {
    image-rendering: auto;
  }

    /* ===== Dark Mode Overrides ===== */
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    body.dark-mode .container {
      background-color: #1e1e1e;
    }
    body.dark-mode .card {
      background-color: #1e1e1e;
      color: #e0e0e0;
      border: 1px solid #333;
    }
    body.dark-mode .border {
      border-color: #444 !important;
    }
    body.dark-mode .bg-light {
      background-color: #2c2c2c !important;
      color: #e0e0e0;
    }
    body.dark-mode .btn-primary {
      background-color: #377FC6;
      border-color: #2c6cb0;
      color: #fff;
    }
    body.dark-mode .btn-primary:hover {
      background-color: #2c6cb0;
      border-color: #255a8a;
    }
    body.dark-mode .btn-danger {
      background-color: #c9302c;
      border-color: #ac2925;
      color: #fff;
    }
    body.dark-mode .btn-danger:hover {
      background-color: #ac2925;
      border-color: #922020;
    }
    body.dark-mode textarea,
    body.dark-mode input[type="file"] {
      background-color: #2c2c2c;
      color: #e0e0e0;
      border: 1px solid #444;
    }

    /* Reply forms */
    .reply-form textarea {
      width: 100%;
      margin-bottom: 10px;
    }

    /* Misc */
    h2, h4, h5 {
      margin-top: 0;
    }
  </style>
</head>
<body class="{% if request.COOKIES.theme == 'dark' %}dark-mode{% endif %}">

  <div class="top-nav">
    <div class="logo">
      <a href="{% url 'index' %}">
        <span style="color:#005BAC;">M</span><span style="color:#005BAC;">M</span><span style="color:#ED1C24;">U</span> Strangers Gossip
      </a>
    </div>

    <form method="GET" action="{% url 'search' %}" class="search-container">
      <input type="text" name="q" placeholder="Search..." required>
    </form>

    <div class="nav-links">
      <a href="{% url 'index' %}">Home</a>
      <a href="{% url 'trending' %}">Trending</a>
      <a href="{% url 'post_confession' %}">Post</a>
      {% if user.is_authenticated %}
        <a href="{% url 'logout' %}">Logout</a>
      {% else %}
        <a href="{% url 'login' %}">Login</a>
        <a href="{% url 'register' %}">Register</a>
      {% endif %}
    </div>
  </div>

  {% load static %}
  <p>Confession</p>
  <br>

  <!-- üü¶ Post Container -->
  <div class="container mt-3">
    <div class="card p-4 mb-4">
      <div class="d-flex align-items-start">
        <!-- Post author's avatar -->
        {% if post_avatar %}
         <img src="{{ post_avatar }}" class="user-avatar me-3" alt="Author avatar">
        {% else %}
         <img src="{% static 'avatars/default_avatar.png' %}" class="user-avatar me-3" alt="Default avatar">
        {% endif %}

        <div style="flex: 1">
          <h2 class="card-title" style="text-align: left;">{{ post.title }}</h2>
          <p style="text-align: left;">{{ post.content }}</p>
          <p style="text-align: left; font-size: 0.9rem;">Posted {{ post.created_at|timesince }} ago</p>

          <div style="text-align: left;" class="mb-3">
            {% if user.is_authenticated %}
              <button class="btn btn-primary like-btn" data-post-id="{{ post.id }}">
                üëç Like (<span id="like-count">{{ post.likes.count }}</span>)
              </button>
         
              {% if is_saved %}
                <button class="btn btn-primary save-btn" data-post-id="{{ post.id }}">
                  üìå Unsave
                </button>
              {% else %}
                <button class="btn btn-primary save-btn" data-post-id="{{ post.id }}">
                  üìå Save
                </button>
              {% endif %}

              <a href="{% url 'report_post' 'post' post.id %}" class="btn btn-danger">
                üö© Report
              </a>
              {% if post.user == request.user or post.session_key == request.session.session_key %}
                <button class="btn btn-danger btn-sm delete-post" data-post-id="{{ post.id }}">üóë Delete</button>
              {% endif %}
            {% else %}
              <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary">
                Login to Interact
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- üü® Comment Section -->
  <div class="container">
    {% if comments %}
      <div class="card p-4 mb-4">
        <h4 style="text-align: left;">Comments</h4>

        {% for comment in comments %}
          <div class="border p-3 mb-3 rounded">
            <div class="d-flex align-items-start">
              <!-- Commenter's avatar -->
              {% if comment.user and comment.user.userprofile.avatar %}
               <img src="{% static 'avatars/'|add:comment.user.userprofile.avatar %}" class="user-avatar me-3" alt="Commenter avatar">
              {% else %}
               <img src="{% static 'avatars/default_avatar.png' %}" class="user-avatar me-3" alt="Default avatar">
              {% endif %}
              <div style="flex: 1">
                <p style="text-align: left;">
                  <strong>
                    {% if comment.session_key == 'anonymous' %}
                      Anonymous
                    {% else %}
                      User {{ comment.session_key }}
                    {% endif %}
                  </strong>: {{ comment.content }}
                </p>
                
                <!-- Add Comment image/GIF display -->
                {% if comment.image %}
                  <div class="mt-2 media-container">
                    <img src="{{ comment.image.url }}" 
                      alt="User upload" 
                      class="user-uploaded-media"
                      style="max-width: 100%; max-height: 300px; border-radius: 8px;">
                  </div>
                {% endif %}

                <div style="text-align: left;">
                  {% if user.is_authenticated %}
                    <button class="btn btn-sm btn-primary comment-like-btn" data-comment-id="{{ comment.id }}">
                      üëç Like (<span id="comment-like-{{ comment.id }}">{{ comment.likes.count }}</span>)
                    </button>
                    <button class="btn btn-sm btn-light reply-btn" data-comment-id="{{ comment.id }}">Reply</button>
                    <a href="{% url 'report_post' 'comment' comment.id %}" class="btn btn-sm btn-light">Report</a>
                    {% if comment.user == request.user or comment.session_key == request.session.session_key %}
                      <button class="btn btn-sm btn-danger delete-comment" data-comment-id="{{ comment.id }}">üóë Delete</button>
                    {% endif %}
                  {% else %}
                    <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-sm btn-light">Login to Interact</a>
                  {% endif %}
                </div>

                <!-- üüß Hidden Reply Form -->
                <div class="reply-form mt-2" id="reply-form-{{ comment.id }}" style="display: none;">
                  <form method="POST" class="reply-submit-form" data-comment-id="{{ comment.id }}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <textarea name="content" class="form-control mb-2" rows="2" placeholder="Write your reply..."></textarea>
                    <div class="d-flex align-items-center mb-2">
                      <input type="file" name="image" id="reply-image-{{ comment.id }}" accept="image/*,.gif" style="display: none;">
                      <button type="button" class="btn btn-sm btn-light me-2" onclick="document.getElementById('reply-image-{{ comment.id }}').click()">
                        üì∑ Add Image/GIF
                      </button>
                      <span id="reply-image-name-{{ comment.id }}" style="font-size: 0.8rem;"></span>
                    </div>
                    <button type="submit" class="btn btn-sm btn-success">Submit Reply</button>
                  </form>
                </div>

                <!-- üü© Replies -->
                {% for reply in comment.replies.all %}
                  <div class="border p-2 mt-2 ms-4 bg-light rounded" style="margin-left: 2rem;">
                    <div class="d-flex align-items-start">
                      <!-- Responder's avatar -->
                      {% if reply.user and reply.user.userprofile.avatar %}
                        <img src="{% static 'avatars/'|add:reply.user.userprofile.avatar %}" class="user-avatar me-2" style="width: 25px; height: 25px;" alt="Replier avatar">
                      {% else %}
                       <img src="{% static 'avatars/default_avatar.png' %}" class="user-avatar me-2" style="width: 25px; height: 25px;" alt="Default avatar">
                      {% endif %}

                      <p style="text-align: left; font-size: 0.95rem;">
                        <strong>
                          {% if reply.session_key == 'anonymous' %}
                            Anonymous
                          {% else %}
                            User {{ reply.session_key }}
                          {% endif %}
                        </strong>: {{ reply.content }}
                      </p>
                    </div>

                    <!-- Add Reply image/GIF display -->
                    {% if reply.image %}
                      <div class="mt-2 media-container">
                        <img src="{{ reply.image.url }}" 
                          alt="Reply upload" 
                          class="user-uploaded-media"
                          style="max-width: 100%; max-height: 250px; border-radius: 8px;">
                      </div>
                    {% endif %}

<div style="text-align: left; margin-top: 5px;">
  <button class="btn btn-sm btn-primary reply-like-btn" data-reply-id="{{ reply.id }}">
    üëç Like (<span id="reply-like-{{ reply.id }}">{{ reply.replylike_set.count }}</span>)
  </button>
  <button class="btn btn-sm btn-light reply-btn" data-comment-id="{{ comment.id }}" data-reply-id="{{ reply.id }}">
    Reply
  </button>
  <a href="{% url 'report_post' 'reply' reply.id %}" class="btn btn-sm btn-light">Report</a>
  {% if reply.user == request.user or reply.session_key == request.session.session_key %}
    <button class="btn btn-sm btn-danger delete-reply" data-reply-id="{{ reply.id }}">üóë Delete</button>
  {% endif %}
</div>

                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
    
    <!-- Comment Form -->
<div class="card p-4 mb-5">
  <h5 style="text-align: left;">Leave a Comment</h5>
  {% if user.is_authenticated %}
   <form id="comment-form" method="POST" enctype="multipart/form-data">
     {% csrf_token %}
     <textarea name="content" rows="3" class="form-control mb-2" placeholder="Write your comment here..."></textarea>
     <div class="d-flex align-items-center mb-2">
       <input type="file" name="image" id="comment-image" accept="image/*,.gif" style="display: none;">
       <button type="button" class="btn btn-sm btn-light me-2" onclick="document.getElementById('comment-image').click()">
         üì∑ Add Image/GIF
       </button>
       <span id="image-filename" style="font-size: 0.8rem; color: #666;"></span>
     </div>
     <input type="hidden" name="post_id" value="{{ post.id }}" />
     <div style="text-align: left;">
       <button type="submit" class="btn btn-primary">Post Comment</button>
     </div>
   </form>
  {% else %}
   <p>Please <a href="{% url 'login' %}">login</a> to comment.</p>
  {% endif %}
</div>

  {% include 'confession/floating_buttons.html' %}
  {% include 'confession/footer.html' %}

  <script src="{% static 'js/main.js' %}"></script>


  <script>
let isSubmitting = false;

function initEventHandlers() {

  $(document).off("click", ".like-btn, .comment-like-btn, .save-btn").on("click", ".like-btn, .comment-like-btn, .save-btn", function(e) {
    if (!userIsAuthenticated) {
      window.location.href = "/login/?next=" + window.location.pathname;
      return false;
    }
  });
  
  $(document).off("click", ".reply-btn").on("click", ".reply-btn", function() {
    const commentId = $(this).data("comment-id");
    $("#reply-form-" + commentId).toggle();
  });

  $(document).off("click", ".delete-post").on("click", ".delete-post", function() {
    if (confirm("Are you sure you want to delete this post?")) {
      const postId = $(this).data("post-id");
      $.ajax({
        url: `/confession/post/delete/${postId}/`,
        method: "POST",
        data: {
          csrfmiddlewaretoken: $("[name=csrfmiddlewaretoken]").val()
        },
        success: function() {
          window.location.href = "{% url 'home' %}";
        },
        error: function(xhr) {
          alert(xhr.responseJSON.error || "Failed to delete post");
        }
      });
    }
  });

  $(document).off('submit', '#comment-form').on('submit', '#comment-form', function(e) {
    e.preventDefault();
    if (isSubmitting) return;
    
    isSubmitting = true;
    const submitBtn = $(this).find('button[type="submit"]');
    submitBtn.prop('disabled', true).text('Posting...');
    
    $.ajax({
      url: '/confession/add_comment/',
      type: 'POST',
      data: new FormData(this),
      processData: false,
      contentType: false,
      success: function(response) {
        if(response.success) {
          location.reload();
        } else {
          alert(response.error || 'Failed to post comment');
        }
      },
      error: function() {
        alert('Submission error, please try again');
      },
      complete: function() {
        isSubmitting = false;
        submitBtn.prop('disabled', false).text('Submit Comment');
      }
    });
  });

$(document).off('submit', '.reply-submit-form').on('submit', '.reply-submit-form', function(e) {
  e.preventDefault();
  if (isSubmitting) return;
  
  isSubmitting = true;
  const form = $(this);
  const submitBtn = form.find('button[type="submit"]');
  submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> In progress...');

  console.log("Submit data:", {
    comment_id: form.data('comment-id'),
    content: form.find('textarea').val(),
    hasImage: !!form.find('input[type="file"]')[0].files[0]
  });

  const formData = new FormData(this);
  formData.append('comment_id', form.data('comment-id'));

  $.ajax({
    url: '/confession/add_reply/',
    type: 'POST',
    data: formData,
    processData: false,
    contentType: false,
    success: function(response) {
      if(response && response.success) {
        location.reload();
      } else {
        const errorMsg = response?.error || 
                       response?.detail || 
                       'Unknown error occurred';
        alert('Failed to submit: ' + errorMsg);
      }
    },
    error: function(xhr) {
      let errorMsg = "Server Error";
      try {
        const err = JSON.parse(xhr.responseText);
        errorMsg = err.error || err.detail || JSON.stringify(err);
      } catch(e) {
        errorMsg = xhr.statusText;
      }
      alert('Error: ' + errorMsg + ' (status code: ' + xhr.status + ')');
    },
    complete: function() {
      isSubmitting = false;
      submitBtn.prop('disabled', false).text('Submit Reply');
    }
  });
});
}

function initImageHandlers() {
  document.querySelectorAll('.user-uploaded-media').forEach(img => {
    img.onerror = function() {
      this.src = "{% static 'images/default_media.png' %}";
      this.alt = "Image cannot loading";
    };

    const src = img.src;
    img.src = '';
    img.src = src + '?' + new Date().getTime();
  });
}

$(document).ready(function() {
  initEventHandlers();
  initImageHandlers();
  
  document.getElementById('comment-image')?.addEventListener('change', function(e) {
    document.getElementById('image-filename').textContent = e.target.files[0]?.name || '';
  });
});

    // Dark mode toggle
    $("#toggle-dark-mode").on("click", function () {
      $("body").toggleClass("dark-mode");
    });

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');
  </script>
</body>
</html>